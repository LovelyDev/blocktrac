================
Deployment guide
================

Setup 5 servers:
- ziti_db
  - postgresql
- ziti_api
  - ziti application
- zitui
  - httpd
  - zitui webapp
- zitz1
  - backups
- zitz2
  - backups

Startup linodes for each of the servers
- ziti_db  (Linode 4GB)
- ziti_api (Linode 4GB)
- zitui    (Linode 2GB)
- zitz1    (Linode 2GB)
- zitz2    (Linode 2GB) - different data center

Edit DNS:
- point zerptracker.com A and AAAA records at zitui
- point zerptracker.net A and AAAA records at zitui
- point api.zerptracker.com A and AAAA records at ziti_api
- point api.zerptracker.net A and AAAA records at ziti_api

All servers prequisites
-----------------------
1. Install CentOS8
   - Minimal install
   - Full disk
   - Enable network
   - Set root pass
   - Create user w/ admin privilages
2. sudo dnf update
3. set hostname in /etc/hostname
4. Add private ip via linode dashboard
5. sudo reboot

ziti_db
-------
postgrsql setup:
1. dnf install postgresql-server
2. postgresql-setup initdb
3. vi /var/lib/pgsql/data/pg_hba.conf
  - <change local, host ipv4, and host ipv6 to reject>
  - <add>: hostssl all             all                    <ZITI IP ADDR>/32      md5 clientcert=1
4. openssl genrsa -des3 -out server.key 2048 # any passphrase
5. openssl rsa -in server.key -out server.key # removes passphrase
6. chmod 400 server.key
7. chown postgres.postgres server.key
8. openssl req -new -key server.key -days 3650 -out server.crt -x509 -subj '/CN=ziti_db'
9. chmod 400 server.crt
10. chown postgres.postgres server.crt
11. cp server.crt root.crt
12. chown postgres.postgres server.crt
13. vi /var/lib/pgsql/data/postgresql.conf
    - <make following changes>:
      listen_addresses = '<IP SERVER WILL LISTEN ON>'
      ssl = on
      ssl_ca_file = 'root.crt'
14. systemctl enable postgresql.service
15. systemctl start postgresql.service
16. firewall-cmd --permanent --add-rich-rule='
    rule family="ipv4"
    source address="192.168.195.58/32"
    port protocol="tcp" port="5432" accept' 
17. firewall-cmd --reload
18. su - postgres
19. createuser --interactive --pwprompt # answers: ziti / <password> / <password> / n / n / n
20. createdb -O ziti ziti

ziti_api
----
user setup:
1. <Set ziti_db ip in /etc/hosts>
2. adduser ziti
3. passwd ziti
4. touch /var/log/ziti.log
5. chown ziti.ziti /var/log/ziti.log

postgresql setup:
6. <login as ziti>
7. mkdir .postgresql
8. cd .postgresql
9. openssl genrsa -des3 -out postgresql.key 2048 # any passphrase
10. openssl rsa -in postgresql.key -out postgresql.key # remove passphrase 
11. openssl req -new -key postgresql.key -out postgresql.csr -subj '/CN=ziti'
12. scp postgresql.csr ziti_db:~/
13. <on ziti_db>:  openssl x509 -req -days 3650 -in postgresql.csr -CA /var/lib/pgsql/data/root.crt -CAkey /var/lib/pgsql/data/server.key -out postgresql.crt -CAcreateserial
14. scp ziti_db:~/postgresql.crt .
15. scp ziti_db:/var/lib/pgsql/data/root.crt .
16. chmod 600 postgrseql.*

ziti setup:
17. <as root>
18. curl --silent --location https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo
19. rpm --import https://dl.yarnpkg.com/rpm/pubkey.gpg
20. dnf install epel-release
21. dnf install git screen htop nodejs yarn python2 make gcc-c++ redhat-rpm-config postgresql-devel
22. <as ziti>
23. git clone git@bitbucket.org:movitto/ziti.git
24. cd ziti
25. CXXFLAGS="-Wno-cast-function-type" yarn install
26. edit config/config.js to point to db
27. NODE_ENV='production' yarn db:migrate
28. NODE_ENV='production' yarn db:seed
29. screen
30. htop
31. NODE_ENV='production' yarn serve
32. ... listen_to_txs
33. ... run_filters
34. ... notify_sinks
35. ... manage_users
36. <detach from screen>

network setup:
37. firewall-cmd --permanent --add-masquerade
38. firewall-cmd --permanent --add-forward-port=port=80:proto=tcp:toport=3000
38. firewall-cmd --permanent --add-forward-port=port=443:proto=tcp:toport=3001
39. firewall-cmd --permanent --add-service=http
40. firewall-cmd --permanent --add-service=https
41. firewall-cmd --direct --permanent --add-rule ipv4 nat OUTPUT 0 -p tcp -o lo --dport 80 -j REDIRECT --to-ports 3000
42. firewall-cmd --reload

letsencrypt setup:
43. mkdir /home/ziti/letsencrypt
44. mkdir /home/ziti/letsencrypt/certs
45. mkdir /home/ziti/letsencrypt/private
46. chmod 750 /home/ziti/letsencrypt/
47. chmod 775 /home/ziti/letsencrypt/certs
48. chmod 750 /home/ziti/letsencrypt/private
49. curl https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py > /home/ziti/acme_tiny.py
50. chmod 750 /home/ziti/acme_tiny.py
51. openssl genrsa 4096 > /home/ziti/letsencrypt/private/account.key
52. openssl genrsa 4096 > /home/ziti/letsencrypt/private/apizerptrackercom.key
53. openssl req -new -sha256 -key /home/ziti/letsencrypt/private/apizerptrackercom.key -subj "/CN=api.zerptracker.com" > /home/ziti/letsencrypt/private/apizerptrackercom.csr
54. chmod 640 /home/ziti/letsencrypt/private/account.key
55. chmod 640 /home/ziti/letsencrypt/private/apizerptrackercom.key
56. chmod 640 /home/ziti/letsencrypt/private/apizerptrackercom.csr
57. vi /home/ziti/renew_cert.sh
    - <add>
    python2 /home/ziti/acme_tiny.py --account-key /home/ziti/letsencrypt/private/account.key --csr /home/ziti/letsencrypt/private/apizerptrackercom.csr --acme-dir /home/ziti/ziti/.well-known/acme-challenge/ > /home/ziti/letsencrypt/certs/signed-apizerptrackercom.crt || exit
    curl https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem > /home/ziti/letsencrypt/certs/intermediate-apizerptrackercom.pem
    cat /home/ziti/letsencrypt/certs/signed-apizerptrackercom.crt /home/ziti/letsencrypt/certs/intermediate-apizerptrackercom.pem > /home/ziti/letsencrypt/certs/chained_cert-apizerptrackercom.pem
58. chmod 750 /home/ziti/renew_cert.sh
60. /home/ziti/renew_cert.sh
61. <as root>
62. touch /var/log/acme_tiny.log
63. chown ziti.ziti /var/log/acme_tiny.log
64. <as ziti>
65. EDITOR="vi" crontab -e
    - add
    30 3 1 Feb,Apr,Jun,Aug,Oct,Dec * /home/ziti/renew_cert.sh >> /var/log/acme_tiny.log

zitui
-----
httpd/zitui setup:
1. dnf install httpd mod_ssl rsync
2. mkdir /var/www/zitui
3. <on local machine>
4. scp httpd.conf root@zitui:/etc/httpd/conf.d/zerptrackercom.conf # comment out mod_ssl / 443 sections / https redirects for now
5. Edit src/config.js to reference BACKEND_URL
6. ./deploy
7. <on zitui>
8. chown -R root.root /var/www/zitui
9. service httpd start
10. firewall-cmd --permanent --add-service=http
11. firewall-cmd --permanent --add-service=https
12. firewall-cmd --reload

letsencrypt certificate:
13. dnf install python3
14. adduser letsencrypt
15. passwd letsencrypt
16. groupadd letsencrypt
17. mkdir /etc/letsencrypt
18. mkdir /etc/letsencrypt/certs
19. mkdir /etc/letsencrypt/private
20. chown -R root:letsencrypt /etc/letsencrypt
21. chmod 750 /etc/letsencrypt/
22. chmod 775 /etc/letsencrypt/certs
23. chmod 750 /etc/letsencrypt/private
24. usermod -a -G letsencrypt rippled
25. mkdir -p /var/www/<COMPACT_HOSTNAME>/.well-known/acme-challenge
26. chown -R letsencrypt.letsencrypt /var/www/zitui/.well-known/
27. curl https://raw.githubusercontent.com/diafygi/acme-tiny/master/acme_tiny.py > /home/letsencrypt/acme_tiny.py
28. chown root.letsencrypt /home/letsencrypt/acme_tiny.py
29. chmod 750 /home/letsencrypt/acme_tiny.py
30. openssl genrsa 4096 > /etc/letsencrypt/private/account.key
31. openssl genrsa 4096 > /etc/letsencrypt/private/zerptrackercom.key
32. openssl dhparam -out /etc/letsencrypt/certs/dhparam.pem 4096 # general locally then scp to zitui (is dhparam needed? not referenced anywhere)
33. openssl req -new -sha256 -key /etc/letsencrypt/private/zerptrackercom.key -subj "/CN=zerptracker.com" > /etc/letsencrypt/private/zerptrackercom.csr
34. su letsencrypt
35. cd
36. vi /home/letencrypt/renew_cert.sh
    - <add>
    python3 /home/letsencrypt/acme_tiny.py --account-key /etc/letsencrypt/private/account.key --csr /etc/letsencrypt/private/zerptrackercom.csr --acme-dir /var/www/zitui/.well-known/acme-challenge/ > /etc/letsencrypt/certs/signed-zerptrackercom.crt || exit
    curl https://letsencrypt.org/certs/lets-encrypt-x1-cross-signed.pem > /etc/letsencrypt/certs/intermediate-zerptrackercom.pem
    cat /etc/letsencrypt/certs/signed-zerptrackercom.crt /etc/letsencrypt/certs/intermediate-zerptrackercom.pem > /etc/letsencrypt/certs/chained_cert-zerptrackercom.pem
37. chmod 750 /home/letsencrypt/renew_cert.sh
38. ./renew_cert.sh # verify success
39. exit
40. chown root:letsencrypt /home/letsencrypt/renew_cert.sh
41. chmod 750 /home/letsencrypt/renew_cert.sh
42. chown root:letsencrypt /etc/letsencrypt/private/account.key
43. chown root:letsencrypt /etc/letsencrypt/private/zerptrackercom.csr
44. chown root:letsencrypt /etc/letsencrypt/private/zerptrackercom.key
45. chown letsencrypt.letsencrypt /etc/letsencrypt/certs/dhparam.pem
46. chmod 640 /etc/letsencrypt/private/account.key
47. chmod 640 /etc/letsencrypt/private/zerptrackercom.csr
48. chmod 640 /etc/letsencrypt/private/zerptrackercom.key
49. chmod 640 /etc/letsencrypt/certs/dhparam.pem
50. vi /etc/httpd/conf.d/zerptrackercom.conf
    - uncomment ssl / 443 sections / https redirect
51. vi /etc/httpd/conf.d/ssl.conf
    - comment out entire virtual host
52. service httpd reload
53. EDITOR="vi" visudo -f /etc/sudoers.d/letsencrypt-services-reload
    - add the following:
    letsencrypt ALL=NOPASSWD: /usr/sbin/service httpd reload
54. vi /home/letencrypt/renew_cert.sh
    - append
     sudo service httpd reload
55. su letsencrypt
56. EDITOR="vi" crontab -e
    - add
    30 3 1 Feb,Apr,Jun,Aug,Oct,Dec * /home/letsencrypt/renew_cert.sh >> /var/log/acme_tiny.log
57. exit
58. touch /var/log/acme_tiny.log
59. chown letsencrypt.letsencrypt /var/log/acme_tiny.log
60. chmod 640 /var/log/acme_tiny.log

zitz1/zitz2
-----------
...

Post Setup
----------
- On *all* servers edit /etc/ssh/sshd_config and disable PermitRootLogin, restart ssh
- Backup all keys & passwords
